<!--
* @Author                : Jbristhuille<jean-baptiste@halfsquare.fr>
* @CreatedDate           : 2023-09-21 13:14:00
* @LastEditors           : Jbristhuille<jean-baptiste@halfsquare.fr>
* @LastEditDate          : 2023-09-30 15:48:38
-->

<div class="ptt">
  <section-ptt-tool-bar [isParentOf]="type != 'tickets'"
                        [isAssignee]="isAssignee"
                        (onDelete)="deleteItem()"
                        (onCreateChild)="newItem()"
                        (onAssign)="assigneeUser(user.getUser(), true)"/>

  <div class="container">
    <div class="main">
      <div class="header">
        <section-ptt-header
          *ngIf="_.find(type == 'tickets' ? tickets : (type == 'projects' ? projects : tasks), {id: id})"
          [editTitle]="onEdit"
          [editDescription]="onEdit"
          (callback)="headerSave($event)"
          [title]="_.find(type == 'tickets' ? tickets : (type == 'projects' ? projects : tasks), {id: id}).name"
          [description]="_.find(type == 'tickets' ? tickets : (type == 'projects' ? projects : tasks), {id: id}).description">
        </section-ptt-header>
      </div>

      <div *ngIf="type != 'tickets'" class="advancement">

        <section-ptt-advancement [value]="progressValue"></section-ptt-advancement>

        <section-ptt-list
          [elements]="_.filter(type === 'projects' ? printTasks : printTickets, type === 'projects' ? {projectId: id} : {taskId: id})"
          [type]="typeChild">

          <ng-container sort>
            {{type === "projects" ? "Tasks" : "Tickets"}}
            <component-select
              *ngIf="type === 'projects' ? _.find(versions, {projectId: id}) :
                    _.find(tasks, {id: id}) &&
                    _.find(tasks, {id: id}).projectId &&
                    _.find(versions, {projectId: _.find(tasks, {id: id}).projectId})"

              [data]="_.filter(versions, {projectId: type === 'projects' ? id : _.find(tasks, {id: id}).projectId})"
              [placeholder]="'Select verions to sort...'"
              [multi]="true"
              [hasSearch]="false"
              (callback)="sortElement($event)">
            </component-select>
          </ng-container>

          <div class="add" add>
            <core-icon icon="plus"></core-icon>
            Create new {{type === "projects" ? "task" : "ticket"}}
          </div>

        </section-ptt-list>
      </div>

      <div class="comment">
        <section-ptt-comment (callback)="commentPublish($event)" [comments]="comments"></section-ptt-comment>
      </div>
    </div>

    <aside class="aside">
      <div class="details">
        <section-ptt-details
          [id]="id"
          [type]="type"
          [owner]="currentElement.ownerId"
          [assignee]="currentElement.assignments"
          (cbAssignee)="assigneeUser($event, false)"
          [versionTitle]="type === 'projects' ? 'Version' : 'Target version'"
          [versions]="_.filter(versions, {projectId: type === 'projects' ? id : _.find(tasks, {id: type === 'tasks' ? id : currentElement.taskId}).projectId})"
          [currentVersion]="type === 'projects' ? currentElement.actualVersion : currentElement.targetVersionId"
          (cbVersions)="changeVersion($event)"
          [status]="[{id:'new', status: 'new'}, {id:'progress', status: 'progress'}, {id:'done', status: 'done'}, {id:'reject', status: 'reject'}, {id:'wait', status: 'wait'}]"
          (cbStatus)="changeStatus($event)"
          [currentStatus]="[{id: currentElement.status, status: currentElement.status}]"
          [currentLabels]="currentElement.labels"
          (cbLabels)="changeLabels($event)"
          [levels]="[{id: 'low', level:'low'}, {id: 'normal', level:'normal'}, {id: 'moderate', level:'moderate'}, {id: 'high', level:'high'}]"
          (cbLevel)="changeLevel($event)"
          [currentLevel]="[{id: currentElement.level, level: currentElement.level}]"
          [listTitle]="type === 'projects' ? 'tasks' : 'tickets'"
          [nbList]="_.filter(type === 'projects' ? printTasks : printTickets, type === 'projects' ? {projectId: id} : {taskId: id}).length"
          [created]="currentElement.created"
        ></section-ptt-details>
      </div>

      <div class="activity">
        <component-activity-item [reduce]="true" *ngFor="let activity of activities | slice:0:15" [activity]="activity"/>
      </div>
    </aside>
  </div>


</div>
